<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eaze WebSocket Load Tester</title>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-muted: #6c757d;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { margin: 0; color: #2c3e50; font-weight: 300; font-size: 2.5rem; }
        header p { color: var(--text-muted); margin-top: 5px; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 850px) { .dashboard { grid-template-columns: 1fr; } }
        
        .card { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; }
        .card h2 { margin-top: 0; font-size: 1.1rem; color: #2c3e50; border-bottom: 2px solid #f1f3f5; padding-bottom: 12px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 0.95rem; transition: border-color 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .form-group textarea { resize: vertical; height: 80px; font-family: monospace; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-item { padding: 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .stat-item .value { font-size: 1.8rem; font-weight: 700; display: block; line-height: 1.2; }
        .stat-item .label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-top: 4px; opacity: 0.8; }
        
        .bg-primary { background-color: #e7f1ff; color: #0056b3; }
        .bg-success { background-color: #d4edda; color: #155724; }
        .bg-danger { background-color: #f8d7da; color: #721c24; }
        .bg-warning { background-color: #fff3cd; color: #856404; }
        
        .controls { text-align: center; margin: 30px 0; }
        button { padding: 12px 30px; font-size: 1rem; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; min-width: 180px; }
        .btn-start { background-color: var(--success-color); color: white; box-shadow: 0 4px 14px 0 rgba(40, 167, 69, 0.39); }
        .btn-start:hover { background-color: #218838; transform: translateY(-1px); }
        .btn-stop { background-color: var(--danger-color); color: white; margin-left: 15px; box-shadow: 0 4px 14px 0 rgba(220, 53, 69, 0.39); }
        .btn-stop:hover { background-color: #c82333; transform: translateY(-1px); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; box-shadow: none; transform: none; }

        .log-container { margin-top: 20px; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; height: 350px; overflow-y: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; }
        .log-entry { margin-bottom: 5px; padding: 2px 5px; border-radius: 3px; }
        .log-error { color: #f48771; background: rgba(244, 135, 113, 0.1); }
        .log-success { color: #89d185; background: rgba(137, 209, 133, 0.1); }
        .log-info { color: #9cdcfe; }
        .log-warning { color: #cca700; }
        .timestamp { color: #808080; margin-right: 10px; font-size: 0.8rem; }

        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-idle { background-color: #adb5bd; }
        .status-running { background-color: var(--success-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Eaze WebSocket Load Tester</h1>
            <p>Simulate high-concurrency traffic and monitor server performance</p>
        </header>
        
        <div class="dashboard">
            <!-- Configuration Card -->
            <div class="card">
                <h2><span id="test-status-dot" class="status-indicator status-idle"></span> Configuration</h2>
                <div class="form-group">
                    <label for="serverUrl">Server WebSocket URL</label>
                    <input type="text" id="serverUrl" value="ws://localhost:8080" placeholder="ws://hostname:port/path">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="connCount">Concurrent Connections</label>
                        <input type="number" id="connCount" value="50" min="1" step="10">
                    </div>
                    <div class="form-group">
                        <label for="connInterval">Ramp-up Delay (ms)</label>
                        <input type="number" id="connInterval" value="50" min="0" step="10">
                    </div>
                </div>
                <div class="form-group">
                    <label for="msgInterval">Message Interval (ms)</label>
                    <input type="number" id="msgInterval" value="1000" min="10" step="100">
                </div>
                <div class="form-group">
                    <label for="payload">Message Payload (JSON or Text)</label>
                    <textarea id="payload">{"client_id": "ID_PLACEHOLDER", "type": "ping", "ts": TS_PLACEHOLDER}</textarea>
                    <small style="color: var(--text-muted); font-size: 0.75rem;">Use ID_PLACEHOLDER and TS_PLACEHOLDER for dynamic values.</small>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <h2>Real-time Metrics</h2>
                <div class="stats-grid">
                    <div class="stat-item bg-primary">
                        <span class="value" id="stat-active">0</span>
                        <span class="label">Active Connections</span>
                    </div>
                    <div class="stat-item bg-success">
                        <span class="value" id="stat-success">0</span>
                        <span class="label">Total Established</span>
                    </div>
                    <div class="stat-item bg-danger">
                        <span class="value" id="stat-failed">0</span>
                        <span class="label">Connect Failures</span>
                    </div>
                    <div class="stat-item bg-primary">
                        <span class="value" id="stat-sent">0</span>
                        <span class="label">Messages Sent</span>
                    </div>
                    <div class="stat-item bg-danger">
                        <span class="value" id="stat-errors">0</span>
                        <span class="label">Delivery Errors</span>
                    </div>
                    <div class="stat-item bg-warning">
                        <span class="value" id="stat-received">0</span>
                        <span class="label">Messages Received</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn-start" onclick="startLoadTest()">
                <span>Start Load Test</span>
            </button>
            <button id="stopBtn" class="btn-stop" onclick="stopLoadTest()" disabled>
                <span>Stop Load Test</span>
            </button>
        </div>

        <div class="card log-container">
            <h2>Activity Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <script src="eaze_websocket_client.js"></script>
    <script>
        let clients = [];
        let testRunning = false;
        let stats = {
            active: 0,
            success: 0,
            failed: 0,
            sent: 0,
            errors: 0,
            received: 0
        };

        const logDiv = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDot = document.getElementById('test-status-dot');

        function updateStatsUI() {
            document.getElementById('stat-active').textContent = stats.active;
            document.getElementById('stat-success').textContent = stats.success;
            document.getElementById('stat-failed').textContent = stats.failed;
            document.getElementById('stat-sent').textContent = stats.sent;
            document.getElementById('stat-errors').textContent = stats.errors;
            document.getElementById('stat-received').textContent = stats.received;
        }

        function log(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const ts = document.createElement('span');
            ts.className = 'timestamp';
            ts.textContent = new Date().toLocaleTimeString();
            
            entry.appendChild(ts);
            entry.appendChild(document.createTextNode(msg));
            
            logDiv.prepend(entry);
            
            // Keep log size manageable
            if (logDiv.childNodes.length > 200) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        async function startLoadTest() {
            const url = document.getElementById('serverUrl').value;
            const count = parseInt(document.getElementById('connCount').value);
            const connInterval = parseInt(document.getElementById('connInterval').value);
            const msgInterval = parseInt(document.getElementById('msgInterval').value);
            const payloadTemplate = document.getElementById('payload').value;

            if (!url) {
                alert('Please enter a server URL');
                return;
            }

            testRunning = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            statusDot.className = 'status-indicator status-running';
            
            // Reset stats
            stats = { active: 0, success: 0, failed: 0, sent: 0, errors: 0, received: 0 };
            updateStatsUI();
            log(`Initiating load test: ${count} connections to ${url}`, 'info');

            for (let i = 0; i < count; i++) {
                if (!testRunning) break;
                
                spawnConnection(url, msgInterval, payloadTemplate, i + 1);
                
                if (connInterval > 0 && i < count - 1) {
                    await new Promise(resolve => setTimeout(resolve, connInterval));
                }
            }
        }

        function spawnConnection(url, msgInterval, payloadTemplate, id) {
            const client = new EazeWebSocketClient(url);
            let messageTimer = null;
            let hasConnected = false;

            client.onOpen(() => {
                hasConnected = true;
                stats.active++;
                stats.success++;
                updateStatsUI();
                log(`[Conn #${id}] Connected`, 'success');

                messageTimer = setInterval(() => {
                    if (!testRunning) {
                        clearInterval(messageTimer);
                        return;
                    }
                    try {
                        const finalPayload = payloadTemplate
                            .replace('ID_PLACEHOLDER', id)
                            .replace('TS_PLACEHOLDER', Date.now());
                        
                        client.send(finalPayload);
                        stats.sent++;
                        updateStatsUI();
                    } catch (e) {
                        stats.errors++;
                        updateStatsUI();
                        log(`[Conn #${id}] Send error: ${e.message}`, 'error');
                    }
                }, msgInterval);
            });

            client.onMessage((data) => {
                stats.received++;
                updateStatsUI();
            });

            client.onClose((code, reason) => {
                if (messageTimer) clearInterval(messageTimer);
                
                if (hasConnected) {
                    stats.active = Math.max(0, stats.active - 1);
                    log(`[Conn #${id}] Closed (Code: ${code})`, 'info');
                } else {
                    stats.failed++;
                    log(`[Conn #${id}] Failed to establish connection`, 'error');
                }
                updateStatsUI();
            });

            client.onError((err) => {
                if (!hasConnected) {
                    // Handled by onClose usually, but logging error specifically
                    log(`[Conn #${id}] Connection error`, 'error');
                }
            });

            try {
                client.connect();
                clients.push(client);
            } catch (e) {
                if (!hasConnected) stats.failed++;
                updateStatsUI();
                log(`[Conn #${id}] Runtime error: ${e.message}`, 'error');
            }
        }

        function stopLoadTest() {
            testRunning = false;
            statusDot.className = 'status-indicator status-idle';
            log('Terminating all connections...', 'warning');
            
            clients.forEach(client => {
                try {
                    client.close();
                } catch (e) {}
            });
            
            clients = [];
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            setTimeout(() => {
                log('Load test stopped. Final stats updated.', 'info');
                updateStatsUI();
            }, 500);
        }
    </script>
</body>
</html>
